# file: internal/bootstrap/templates/k0s_kairos_cloud_config.yaml.tmpl
#cloud-config

{{- /* 
Template inputs (from Go):

  .Role              string   // "control-plane" or "worker"
  .SingleNode        bool     // true for single-node k0s (controller-only)
  .UserName          string   // e.g. "kairos"
  .UserPassword      string   // e.g. "kairos"
  .UserGroups        []string // e.g. ["admin"]
  .GitHubUser        string   // e.g. "YOUR_GITHUB_USER" (optional)
  .SSHPublicKey      string   // alternative to GitHubUser (optional)
  .WorkerToken       string   // used only for workers
  .ExtraManifests    []Manifest // optional, see below
  .HostnamePrefix    string   // e.g. "metal-"
*/ -}}

{{/* Hostname: we want to preserve Kairos templating: metal-{{ trunc 4 .MachineID }} */}}
hostname: {{ .HostnamePrefix }}{{"{{ trunc 4 .MachineID }}"}}

users:
- name: {{ .UserName }}
  passwd: {{ .UserPassword }}
  groups:
  {{- range .UserGroups }}
    - {{ . }}
  {{- end }}
  ssh_authorized_keys:
  {{- if .GitHubUser }}
    - github:{{ .GitHubUser }}
  {{- end }}
  {{- if .SSHPublicKey }}
    - {{ .SSHPublicKey }}
  {{- end }}

{{- if eq .Role "control-plane" }}

# Control-plane node configuration
k0s:
  enabled: true
  {{- if .SingleNode }}
  args:
    - --single
  {{- end }}

{{- else }}

# Worker node configuration
k0s-worker:
  enabled: true
  args:
    - --token-file /etc/k0s/token

write_files:
  - path: /etc/k0s/token
    permissions: "0644"
    content: |
      {{ .WorkerToken }}

{{- end }}

{{- if .ExtraManifests }}

# Optional extra manifests to be applied by k0s from /var/lib/k0s/manifests
write_files:
{{- range .ExtraManifests }}
  - path: /var/lib/k0s/manifests/{{ .Name }}/{{ .File }}
    permissions: "0644"
    content: |
{{ .Content | indent 6 }}
{{- end }}
{{- else }}

# Example manifest (nginx) â€“ remove/override via ExtraManifests in spec if not desired.
write_files:
  - path: /var/lib/k0s/manifests/nginx/nginx.yaml
    permissions: "0644"
    content: |
      apiVersion: v1
      kind: Namespace
      metadata:
        name: nginx
      ---
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: nginx-deployment
        namespace: nginx
      spec:
        selector:
          matchLabels:
            app: nginx
        replicas: 3
        template:
          metadata:
            labels:
              app: nginx
          spec:
            containers:
            - name: nginx
              image: nginx:latest
              ports:
              - containerPort: 80
{{- end }}
