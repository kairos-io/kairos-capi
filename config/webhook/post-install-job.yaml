# Post-install Job to inject CA bundle into webhook configurations
# This job runs after deployment to ensure webhooks have the correct CA bundle
# It should be included in the deployment manifests and run automatically

apiVersion: batch/v1
kind: Job
metadata:
  name: kairos-capi-webhook-ca-injection
  namespace: kairos-capi-system
  annotations:
    # This job should only run once
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: kairos-capi-webhook-ca-injection
    spec:
      restartPolicy: OnFailure
      serviceAccountName: kairos-capi-manager
      containers:
      - name: ca-injection
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail
          
          echo "Waiting for certificate to be ready..."
          kubectl wait --for=condition=ready certificate/kairos-capi-webhook-server-cert \
            -n kairos-capi-system \
            --timeout=300s || {
            echo "ERROR: Certificate not ready after 5 minutes"
            exit 1
          }
          
          echo "Certificate is ready. Extracting CA bundle..."
          CA_BUNDLE=$(kubectl get secret kairos-capi-webhook-server-cert \
            -n kairos-capi-system \
            -o jsonpath='{.data.ca\.crt}')
          
          if [ -z "${CA_BUNDLE}" ]; then
            echo "ERROR: Failed to extract CA bundle from secret"
            exit 1
          fi
          
          echo "Patching mutating webhook configuration..."
          kubectl patch mutatingwebhookconfiguration mutating-webhook-configuration \
            --type='json' \
            -p="[
              {\"op\": \"replace\", \"path\": \"/webhooks/0/clientConfig/caBundle\", \"value\": \"${CA_BUNDLE}\"},
              {\"op\": \"replace\", \"path\": \"/webhooks/1/clientConfig/caBundle\", \"value\": \"${CA_BUNDLE}\"}
            ]" || {
            echo "ERROR: Failed to patch mutating webhook configuration"
            exit 1
          }
          
          echo "Patching validating webhook configuration..."
          kubectl patch validatingwebhookconfiguration validating-webhook-configuration \
            --type='json' \
            -p="[
              {\"op\": \"replace\", \"path\": \"/webhooks/0/clientConfig/caBundle\", \"value\": \"${CA_BUNDLE}\"},
              {\"op\": \"replace\", \"path\": \"/webhooks/1/clientConfig/caBundle\", \"value\": \"${CA_BUNDLE}\"}
            ]" || {
            echo "ERROR: Failed to patch validating webhook configuration"
            exit 1
          }
          
          echo "Successfully injected CA bundle into webhook configurations"
          echo "Restarting controller to pick up changes..."
          kubectl rollout restart deployment/kairos-capi-controller-manager -n kairos-capi-system || true
          
          echo "Done!"
