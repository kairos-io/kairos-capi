apiVersion: cluster.x-k8s.io/v1beta2
kind: Cluster
metadata:
  name: kairos-cluster
  namespace: default
spec:
  infrastructureRef:
    # Note: In v1beta2, use apiGroup instead of apiVersion
    apiGroup: infrastructure.cluster.x-k8s.io
    kind: VSphereCluster
    name: kairos-cluster
  controlPlaneRef:
    # Note: In v1beta2, use apiGroup instead of apiVersion
    apiGroup: controlplane.cluster.x-k8s.io
    kind: KairosControlPlane
    name: kairos-control-plane

---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereCluster
metadata:
  name: kairos-cluster
  namespace: default
spec:
  server: "https://172.16.56.10/sdk"
  identityRef:
    kind: VSphereClusterIdentity
    name: vsphere-credentials

---
apiVersion: controlplane.cluster.x-k8s.io/v1beta2
kind: KairosControlPlane
metadata:
  name: kairos-control-plane
  namespace: default
spec:
  replicas: 1
  version: "v1.34.1+k0s.1"
  machineTemplate:
    infrastructureRef:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
      kind: VSphereMachineTemplate
      name: kairos-control-plane-template
      namespace: default
  kairosConfigTemplate:
    name: kairos-config-template-control-plane

---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereMachineTemplate
metadata:
  name: kairos-control-plane-template
  namespace: default
spec:
  template:
    spec:
      datacenter: "labk8"
      datastore: "datastore1"
      folder: "research-vms"
      network:
        devices:
          # DHCP Configuration (currently active)
          # Note: VSphere provider v1beta1 does not support setting ipAddrs directly in templates.
          # For static IPs, you need to use IPAM (IP Address Management) with addressesFromPools.
          - networkName: "VM Network"
            dhcp4: true              # Enable DHCP for IPv4
            # When using DHCP, do not specify ipAddrs, gateway4, or nameservers
            # The VM will receive IP configuration from your DHCP server
            
          # Static IP Configuration using IPAM (commented - requires IPAM setup)
          # To use static IPs, you need to:
          # 1. Install an IPAM provider (e.g., MetalLB IPAddressPool)
          # 2. Create an IPAddressPool with your IP range (e.g., 172.16.56.194/24)
          # 3. Use addressesFromPools instead of ipAddrs:
          # - networkName: "VM Network"
          #   addressesFromPools:
          #     - apiGroup: "ipam.metal3.io"
          #       kind: "IPAddressPool"
          #       name: "kairos-ip-pool"
          #   gateway4: "172.16.56.1"  # Gateway for the subnet
          #   nameservers:
          #     - "8.8.8.8"            # DNS servers
          #     - "8.8.4.4"
          #   dhcp4: false              # Disable DHCP when using static IPs
      numCPUs: 4
      memoryMiB: 8192
      diskGiB: 80
      template: "kairos-seed"
      cloneMode: "fullClone"

---
apiVersion: bootstrap.cluster.x-k8s.io/v1beta2
kind: KairosConfigTemplate
metadata:
  name: kairos-config-template-control-plane
  namespace: default
spec:
  template:
    spec:
      role: control-plane
      distribution: k0s
      kubernetesVersion: "v1.34.1+k0s.1"
      userName: kairos
      userPassword: kairos
      userGroups:
        - admin

